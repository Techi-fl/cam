<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Captura de C√¢mera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Seguran√ßa ajustada para funcionar local -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data:;
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    connect-src https://apikk.pythonanywhere.com ws://127.0.0.1:*;
    form-action 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(), geolocation=()">
  <meta http-equiv="Cache-Control" content="no-store">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: #f8f9fa;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    video, canvas {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }
    button, input {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    input {
      width: 90%;
      max-width: 300px;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #status {
      margin-top: 10px;
      font-size: 14px;
      color: green;
    }
  </style>
</head>
<body>
  <h2>üì∑ Captura de C√¢mera</h2>
  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <br>
  <input type="text" id="nomeImagem" placeholder="nome da imagem">
  <br>
  <button onclick="tirarFoto()">üì∏ Foto</button>
  <button onclick="tirarPrint()">üñºÔ∏è Print</button>
  <button onclick="alternarCamera()">üîÑ Trocar C√¢mera</button>
  <p id="status"></p>

  <script>
    let usandoFrontal = true;
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const statusText = document.getElementById('status');
    const nomeInput = document.getElementById('nomeImagem');
    const apiURL = "https://apikk.pythonanywhere.com/upload";

    function gerarNomeAleatorio() {
      const data = new Date();
      return 'imagem_' + data.getTime();
    }

    function iniciarCamera() {
      const constraints = {
        video: { facingMode: usandoFrontal ? "user" : "environment" }
      };
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => video.srcObject = stream)
        .catch(err => alert("Erro ao acessar a c√¢mera: " + err));
    }

    function alternarCamera() {
      usandoFrontal = !usandoFrontal;
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      iniciarCamera();
    }

    function enviarImagem(blob, nome) {
      const formData = new FormData();
      formData.append("foto", blob, nome + ".jpg");
      formData.append("nome", nome + ".jpg");

      fetch(apiURL, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        statusText.textContent = "‚úÖ Enviado: " + nome;
        nomeInput.value = gerarNomeAleatorio(); // novo nome ap√≥s envio
        setTimeout(() => statusText.textContent = "", 3000);
      })
      .catch(err => {
        statusText.textContent = "‚ùå Erro ao enviar.";
      });
    }

    function tirarFoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      const nome = nomeInput.value.trim() || gerarNomeAleatorio();
      canvas.toBlob(blob => enviarImagem(blob, nome), "image/jpeg");
    }

    function tirarPrint() {
      tirarFoto(); // mesma fun√ß√£o da foto
    }

    // Inicializa
    nomeInput.value = gerarNomeAleatorio();
    iniciarCamera();
  </script>
</body>
</html>
